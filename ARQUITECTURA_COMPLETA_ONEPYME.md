# üè¢ ARQUITECTURA COMPLETA ONEPYME

## üìã RESUMEN EJECUTIVO

**OnePyme** es un sistema integral de gesti√≥n empresarial **SINGLE-TENANT** dise√±ado para PYMES argentinas. El sistema incluye m√≥dulos de contabilidad, facturaci√≥n, inventario, CRM, ERP y gesti√≥n de recetas (especialmente para restaurantes).

## üéØ PRINCIPIOS ARQUITECT√ìNICOS

### SINGLE-TENANT (NO Multi-Tenant)
- **UNA SOLA empresa** por instalaci√≥n
- **NO hay separaci√≥n** por `empresa_id` en consultas
- **Todos los usuarios** comparten la misma base de datos
- **Developer tiene super poderes** totales para configuraci√≥n

### ARQUITECTURA FRONTEND
- **React + TypeScript + Vite**
- **Tailwind CSS + shadcn/ui** para componentes
- **Context API** para estado global
- **Hooks personalizados** para cada m√≥dulo
- **Protecci√≥n de rutas** basada en roles

## üóÇÔ∏è ESTRUCTURA COMPLETA DEL SISTEMA

### üì± P√ÅGINAS PRINCIPALES (ROUTING)

#### 1. **AUTENTICACI√ìN**
- `/auth` - Login/Registro
- `/admin-reset-password` - Reset de contrase√±a

#### 2. **DASHBOARD PRINCIPAL**
- `/dashboard` - Vista general del negocio
- `/` - P√°gina de inicio
- `/testing` - Dashboard de testing

#### 3. **M√ìDULO CONTABILIDAD**
- `/facturas` - Gesti√≥n de facturas emitidas/recibidas
- `/ordenes-compra` - √ìrdenes de compra
- `/ordenes-recepcion` - Recepci√≥n de productos
- `/pagos` - Gesti√≥n de pagos
- `/stock` - Control de inventario

#### 4. **M√ìDULO CRM**
- `/crm/clientes` - Gesti√≥n de clientes
- `/crm/oportunidades` - Pipeline de ventas
- `/crm/actividades` - Seguimiento de actividades
- `/crm/campanas` - Campa√±as de marketing

#### 5. **M√ìDULO ERP**
- `/erp/finanzas` - Gesti√≥n financiera
- `/erp/empleados` - Recursos humanos
- `/erp/proyectos` - Gesti√≥n de proyectos
- `/erp/rentabilidad` - An√°lisis de rentabilidad

#### 6. **M√ìDULO ADMINISTRACI√ìN**
- `/admin/usuarios` - Gesti√≥n de usuarios del sistema
- `/configuracion` - Configuraci√≥n general
- `/monitoreo` - Monitoreo del sistema

#### 7. **M√ìDULO ESPECIALIZADO**
- `/recetas` - Gesti√≥n de recetas (restaurantes)

## üóÑÔ∏è ESTRUCTURA DE BASE DE DATOS

### üìä TABLAS PRINCIPALES (43 TABLAS)

#### **1. AUTENTICACI√ìN Y USUARIOS**
```sql
-- Sistema de usuarios y autenticaci√≥n
usuarios ‚úÖ
profiles ‚úÖ
roles ‚úÖ
permisos ‚úÖ
usuarios_roles ‚úÖ
usuarios_permisos ‚úÖ
```

#### **2. EMPRESA**
```sql
-- Empresa principal del sistema (SINGLE-TENANT)
empresa ‚úÖ
-- Proveedores y clientes de la empresa
empresas ‚úÖ
```

#### **3. PRODUCTOS Y STOCK**
```sql
-- Gesti√≥n de inventario
productos ‚úÖ
servicios ‚úÖ
stock ‚úÖ
movimientos_stock ‚úÖ
alertas_stock ‚úÖ
historial_precios ‚úÖ
categorias ‚úÖ
categorias_financieras ‚úÖ
```

#### **4. FACTURACI√ìN**
```sql
-- Sistema de facturaci√≥n completo
facturas_emitidas ‚úÖ
facturas_recibidas ‚úÖ
factura_productos ‚úÖ
pagos ‚úÖ
cobros ‚úÖ
```

#### **5. COMPRAS**
```sql
-- Gesti√≥n de compras y proveedores
ordenes_compra ‚úÖ
recepcion_productos ‚úÖ
```

#### **6. CRM**
```sql
-- Gesti√≥n de relaciones con clientes
clientes ‚úÖ
contactos ‚úÖ
interacciones ‚úÖ
etapas_pipeline ‚úÖ
oportunidades ‚úÖ
actividades ‚úÖ
campanas ‚úÖ
```

#### **7. ERP**
```sql
-- Gesti√≥n empresarial
empleados ‚úÖ
tiempo_trabajado ‚úÖ
proyectos ‚úÖ
tareas_proyecto ‚úÖ
presupuestos ‚úÖ
cash_flow_proyecciones ‚úÖ
indicadores_kpi ‚úÖ
asistencia ‚úÖ
liquidaciones ‚úÖ
```

#### **8. RECETAS (RESTAURANTES)**
```sql
-- Sistema de recetas para restaurantes
recetas ‚úÖ
ingredientes_receta ‚úÖ
ventas_recetas ‚úÖ
```

#### **9. CONFIGURACI√ìN**
```sql
-- Configuraci√≥n del sistema
endpoint_configurations_history ‚úÖ
configuration_backups ‚úÖ
configuration_tests ‚úÖ
```

#### **10. ANAL√çTICAS**
```sql
-- Seguimiento de uso y m√©tricas
user_actions ‚úÖ
user_preferences ‚úÖ
workflow_logs ‚úÖ
workflow_metrics ‚úÖ
```

#### **11. BANCARIO**
```sql
-- Gesti√≥n bancaria
cuentas_bancarias ‚úÖ
transacciones_bancarias ‚úÖ
```

## üîß FUNCIONALIDADES DETALLADAS POR M√ìDULO

### üìä **DASHBOARD PRINCIPAL**
- **M√©tricas contables**: Facturas emitidas/recibidas, √≥rdenes, pagos, stock
- **M√©tricas CRM**: Clientes activos, pipeline de ventas, actividades pendientes
- **M√©tricas ERP**: Cash flow, empleados, proyectos, rentabilidad
- **Alertas del sistema**: Stock bajo, actividades vencidas, facturas pendientes
- **Acciones r√°pidas**: Navegaci√≥n directa a m√≥dulos principales
- **Estado del sistema**: Health checks de servicios (n8n, Supabase)

### üíº **M√ìDULO CONTABILIDAD**

#### **Facturas**
- **Emisi√≥n**: Crear facturas A/B/C con validaci√≥n de CUIT
- **Recepci√≥n**: Registrar facturas de proveedores
- **Gesti√≥n**: Estados (pendiente, emitida, vencida, pagada)
- **Productos**: Asociar productos a facturas
- **PDF**: Generaci√≥n y env√≠o por email
- **Integraci√≥n**: Env√≠o autom√°tico a n8n para procesamiento

#### **√ìrdenes de Compra**
- **Creaci√≥n**: √ìrdenes con proveedores y productos
- **Seguimiento**: Estados (abierta, cerrada, cancelada)
- **Integraci√≥n**: Env√≠o a n8n para confirmaci√≥n de proveedores

#### **Pagos**
- **Registro**: Pagos de facturas emitidas/recibidas
- **M√©todos**: M√∫ltiples formas de pago
- **Seguimiento**: Estados de confirmaci√≥n
- **Integraci√≥n**: Procesamiento autom√°tico v√≠a n8n

#### **Stock**
- **Productos**: SKU, c√≥digos, nombres, descripciones
- **Precios**: Costo, venta sugerido, venta real
- **Movimientos**: Ingresos, egresos, ajustes
- **Alertas**: Stock m√≠nimo autom√°tico
- **Categor√≠as**: Organizaci√≥n por tipos
- **Integraci√≥n**: Movimientos autom√°ticos desde facturas

### üë• **M√ìDULO CRM**

#### **Clientes**
- **Gesti√≥n completa**: CUIT, raz√≥n social, contacto, direcci√≥n
- **Categorizaci√≥n**: VIP, Regular, Nuevo, Importado
- **Importaci√≥n autom√°tica**: Desde facturas emitidas
- **Seguimiento**: Primera compra, monto total, estado
- **Integraci√≥n**: Env√≠o a n8n para procesamiento CRM

#### **Oportunidades**
- **Pipeline de ventas**: Etapas configurables
- **Valor estimado**: Montos y probabilidades
- **Seguimiento**: Actividades y pr√≥ximos pasos
- **Integraci√≥n**: Workflows autom√°ticos v√≠a n8n

#### **Actividades**
- **Tipos**: Llamadas, emails, reuniones, tareas, demos
- **Prioridades**: Alta, media, baja
- **Estados**: Pendiente, completada, vencida
- **Seguimiento**: Fechas y recordatorios

#### **Campa√±as**
- **Marketing**: Campa√±as de email y seguimiento
- **Segmentaci√≥n**: Por categor√≠a de cliente
- **M√©tricas**: Apertura, clics, conversiones

### üè≠ **M√ìDULO ERP**

#### **Finanzas**
- **Presupuestos**: Mensuales por categor√≠as
- **Cash Flow**: Proyecciones de ingresos/egresos
- **KPIs**: Indicadores de rendimiento
- **An√°lisis**: Presupuesto vs real, tendencias
- **Gr√°ficos**: Visualizaci√≥n de datos financieros

#### **Empleados**
- **Gesti√≥n completa**: Datos personales, laborales, bancarios
- **Asistencia**: Control de entrada/salida
- **Licencias**: Tipos y aprobaciones
- **Salarios**: Estructura y liquidaciones

#### **Proyectos**
- **Gesti√≥n completa**: Planificaci√≥n, ejecuci√≥n, cierre
- **Tiempo trabajado**: Registro de horas por empleado
- **Presupuestos**: Estimaciones vs reales
- **Facturaci√≥n**: Horas facturables y realizadas
- **Rentabilidad**: An√°lisis de costos y beneficios

### üç¥ **M√ìDULO RECETAS (RESTAURANTES)**

#### **Gesti√≥n de Recetas**
- **Creaci√≥n**: Ingredientes, cantidades, costos
- **C√°lculo autom√°tico**: Costo total y precio sugerido
- **Stock**: Consumo autom√°tico de ingredientes
- **Ventas**: Registro de ventas con impacto en stock

#### **Integraci√≥n con Stock**
- **Movimientos autom√°ticos**: Al vender recetas
- **Alertas**: Stock insuficiente de ingredientes
- **Costos**: Actualizaci√≥n autom√°tica de precios

### ‚öôÔ∏è **M√ìDULO ADMINISTRACI√ìN**

#### **Usuarios del Sistema**
- **Roles**: Developer, Admin, Contador, Usuario
- **Permisos**: Granular por funcionalidad
- **Gesti√≥n**: Crear, editar, eliminar usuarios
- **Seguridad**: Reset de contrase√±as, bloqueos

#### **Configuraci√≥n**
- **Empresa**: Datos de la empresa principal
- **n8n**: Configuraci√≥n de workflows
- **Sistema**: Par√°metros generales
- **Backups**: Configuraciones guardadas

#### **Monitoreo**
- **Health Checks**: Estado de servicios
- **M√©tricas**: Rendimiento del sistema
- **Logs**: Registro de actividades
- **Alertas**: Notificaciones de problemas

## üîå INTEGRACIONES EXTERNAS

### **n8n (Workflow Automation)**
- **Endpoints**: Webhooks para cada m√≥dulo
- **Procesamiento**: Automatizaci√≥n de tareas
- **Integraci√≥n**: AFIP, email, notificaciones
- **Health Checks**: Monitoreo de conectividad

### **Supabase (Backend)**
- **Base de datos**: PostgreSQL con RLS
- **Autenticaci√≥n**: Sistema de usuarios y sesiones
- **Storage**: Archivos PDF y documentos
- **Real-time**: Actualizaciones en tiempo real

### **Servicios Externos**
- **AFIP**: Validaci√≥n de CUIT y facturaci√≥n
- **Email**: Env√≠o de facturas y notificaciones
- **WhatsApp**: Notificaciones de alertas

## üõ°Ô∏è SEGURIDAD Y PERMISOS

### **Sistema de Roles**
```typescript
enum UserRole {
  developer = 'developer',    // Super poderes totales
  admin = 'admin',           // Administraci√≥n completa
  contador = 'contador',     // M√≥dulos contables
  usuario = 'usuario'        // Acceso limitado
}
```

### **Permisos por Rol**
- **Developer**: Acceso total a todo el sistema
- **Admin**: Gesti√≥n de usuarios y configuraci√≥n
- **Contador**: M√≥dulos contables y reportes
- **Usuario**: Funcionalidades b√°sicas asignadas

### **Row Level Security (RLS)**
- **Pol√≠ticas simples**: `FOR ALL USING (true)` para usuarios autenticados
- **Sin filtros por empresa**: Sistema single-tenant
- **Protecci√≥n b√°sica**: Solo usuarios autenticados

## üìä M√âTRICAS Y ANAL√çTICAS

### **Dashboard Metrics**
- **Contabilidad**: Facturas, √≥rdenes, pagos, stock
- **CRM**: Clientes, oportunidades, actividades
- **ERP**: Finanzas, empleados, proyectos
- **Sistema**: Health checks, performance

### **User Analytics**
- **Acciones del usuario**: Tracking de uso
- **Preferencias**: Configuraciones personalizadas
- **Actividad reciente**: Historial de acciones
- **Quick Actions**: Acciones m√°s utilizadas

### **System Metrics**
- **Performance**: Tiempo de respuesta, uptime
- **Health Checks**: Estado de servicios externos
- **Error Logs**: Registro de problemas
- **Workflow Metrics**: M√©tricas de n8n

## üöÄ IMPLEMENTACI√ìN T√âCNICA

### **Frontend Architecture**
```typescript
// Estructura de componentes
src/
‚îú‚îÄ‚îÄ components/          # Componentes reutilizables
‚îÇ   ‚îú‚îÄ‚îÄ ui/             # Componentes base (shadcn/ui)
‚îÇ   ‚îú‚îÄ‚îÄ facturas/       # Componentes espec√≠ficos de facturas
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/     # Componentes de monitoreo
‚îú‚îÄ‚îÄ pages/              # P√°ginas principales
‚îÇ   ‚îú‚îÄ‚îÄ crm/           # M√≥dulo CRM
‚îÇ   ‚îú‚îÄ‚îÄ erp/           # M√≥dulo ERP
‚îÇ   ‚îî‚îÄ‚îÄ admin/         # Administraci√≥n
‚îú‚îÄ‚îÄ hooks/              # Hooks personalizados
‚îú‚îÄ‚îÄ contexts/           # Context providers
‚îú‚îÄ‚îÄ services/           # Servicios externos
‚îî‚îÄ‚îÄ types/              # Tipos TypeScript
```

### **Data Flow**
1. **Usuario interact√∫a** con componente
2. **Hook personalizado** maneja la l√≥gica de datos
3. **Supabase client** ejecuta consultas
4. **Estado local** se actualiza
5. **UI se re-renderiza** con nuevos datos
6. **Integraci√≥n n8n** se ejecuta en background

### **State Management**
- **Context API**: Estado global (auth, config)
- **Local State**: Estado espec√≠fico de componentes
- **Supabase**: Estado persistente en base de datos
- **Real-time**: Suscripciones para actualizaciones

## üîÑ FLUJOS DE TRABAJO PRINCIPALES

### **Flujo de Facturaci√≥n**
1. Usuario crea factura
2. Sistema valida CUIT
3. Se guarda en Supabase
4. Se env√≠a a n8n para procesamiento
5. Se genera PDF autom√°ticamente
6. Se env√≠a por email al cliente
7. Se actualiza stock si aplica

### **Flujo de CRM**
1. Usuario crea cliente
2. Sistema valida datos
3. Se guarda en Supabase
4. Se env√≠a a n8n para workflows
5. Se crean actividades autom√°ticas
6. Se asignan recordatorios

### **Flujo de Stock**
1. Usuario registra movimiento
2. Sistema actualiza stock
3. Se verifica stock m√≠nimo
4. Se generan alertas si es necesario
5. Se actualiza costo promedio
6. Se registra en historial

## üìà ESCALABILIDAD Y MANTENIMIENTO

### **Arquitectura Escalable**
- **M√≥dulos independientes**: Cada m√≥dulo puede evolucionar por separado
- **Hooks reutilizables**: L√≥gica compartida entre componentes
- **Tipos centralizados**: Definiciones TypeScript consistentes
- **Servicios modulares**: Integraciones separadas por funcionalidad

### **Mantenimiento**
- **C√≥digo limpio**: Estructura clara y documentada
- **Testing**: Componentes testables y aislados
- **Error Handling**: Manejo consistente de errores
- **Logging**: Registro detallado para debugging

### **Performance**
- **Lazy Loading**: Carga de m√≥dulos bajo demanda
- **Optimizaci√≥n de queries**: Consultas eficientes a Supabase
- **Caching**: Datos en memoria cuando es apropiado
- **Real-time**: Actualizaciones sin refrescar p√°gina

## üéØ ROADMAP DE IMPLEMENTACI√ìN

### **Fase 1: Core System (MVP)**
- [x] Autenticaci√≥n y usuarios
- [x] Dashboard principal
- [x] M√≥dulo de facturaci√≥n b√°sico
- [x] Gesti√≥n de stock simple

### **Fase 2: CRM y ERP**
- [ ] Sistema CRM completo
- [ ] Gesti√≥n de empleados
- [ ] Proyectos y tiempo
- [ ] Finanzas y presupuestos

### **Fase 3: Integraciones Avanzadas**
- [ ] Workflows n8n complejos
- [ ] Integraci√≥n AFIP completa
- [ ] Sistema de recetas
- [ ] Reportes avanzados

### **Fase 4: Optimizaci√≥n**
- [ ] Performance y caching
- [ ] Testing completo
- [ ] Documentaci√≥n de usuario
- [ ] Deployment y CI/CD

---

## üìù NOTAS DE IMPLEMENTACI√ìN

### **Consideraciones T√©cnicas**
- **Single-Tenant**: NO implementar filtros por empresa_id
- **RLS Simple**: Pol√≠ticas b√°sicas sin complejidad
- **Error Handling**: Manejo robusto de errores de red
- **Type Safety**: TypeScript estricto en todo el c√≥digo

### **Decisiones de Arquitectura**
- **Frontend First**: UI/UX como prioridad
- **Backend Simple**: Supabase para funcionalidad b√°sica
- **Integraci√≥n n8n**: Automatizaci√≥n de procesos complejos
- **Real-time**: Suscripciones para datos cr√≠ticos

### **Patrones de Dise√±o**
- **Custom Hooks**: L√≥gica de datos reutilizable
- **Context Providers**: Estado global compartido
- **Component Composition**: Componentes modulares
- **Service Layer**: Abstracci√≥n de APIs externas

---

**Documento creado por**: Senior Software Engineer  
**Fecha**: 15 de Agosto, 2025  
**Versi√≥n**: 1.0  
**Estado**: An√°lisis completo del frontend realizado

